<HTML>
<head>
<meta http-equiv=content-type content="text-html; charset=utf-8">
<meta http-equiv=MSThemeCompatible content=yes>
<hta:application
	id=hta_App
	applicationName=ПТК_ПСД_-_Обозреватель_отчетности
	icon=icon.ico
	scroll=no
	contextMenu=no
	singleinstance=yes
	version=3.10.1
	author=mozers™, mozers@mail.ru, icq#256106175
	coauthor=Dmitry Evdokimov, diev@mail.ru, icq#7372116
>
<script language="JavaScript">
// ---------------------------------------------------------
window.resizeTo(780,550); // первоначальные размеры окна приложения
document.title = hta_App.applicationName.replace(/_/g,' ') + ' - ' + hta_App.version;

var current_row = 0;
var old_row = 0;
var select_row = 0;
var select_row_bg = '';
var select_index = 0;
var select_fileName = '';
var select_fileNameTime = '';
var select_filePathNameTime = '';
var ATable = [];
var RCMenu;
var one_filename = '';

var connect;

// Инициализация объектов ActiveX
try {
	var WshShell = new ActiveXObject("WScript.Shell");
	var FSO = new ActiveXObject("Scripting.FileSystemObject");
	var Stream = new ActiveXObject("ADODB.Stream");
} catch(e) {
	alert("Продолжение работы невозможно!\nУстановите Windows Script Host.");
	self.close();
}

var script_path = unescape(document.URL).replace(/.*([A-Z]:\\.*)\\.*$/i, '$1');

var host = GetHostName(script_path);
if (host) { // Если скрипт расположен на сетевом диске, то добавляем хост в список доверенных сайтов
	WshShell.RegWrite('HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Internet Settings\\ZoneMap\\Domains' + host + '\\file', 2, 'REG_DWORD');
}

var INI = {};
ReadINIFile( WshShell.ExpandEnvironmentStrings("%WINDIR%\\elo.ini") );
ReadINIFile( script_path + "\\PTK_PSD_Browser.ini" );
if (!INI.User.CurBik) {
	WshShell.Popup('Не задан БИК !\nЗадайте параметр CurBik в ini-файле', 6, "Ошибка", 48);
	self.close();
}
var bank_code = INI.User.CurBik.replace(/.*(\d{3})$/, '$1');
var ptk_psd_dir = INI.Path.PTKPSD ? (INI.Path.PTKPSD + '\\') : (INI.Path.HOME.replace(/[^\\]*$/, ''));
if (!FSO.FolderExists(ptk_psd_dir)) {
	WshShell.Popup('Каталог установки ПТК ПСД\n' + ptk_psd_dir + '\nне существует!\nОтредактируйте ini-файл', 6, "Ошибка", 48);
	self.close();
}
var store_dir = ptk_psd_dir + 'POST\\Store\\';
var out = WshShell.ExpandEnvironmentStrings('%temp%\\expand.out');
var tmp_dir = WshShell.ExpandEnvironmentStrings("%temp%\\$ptk$");
var unpacker = script_path + '\\bin\\7z.exe';  // Путь к распаковщику (используется 7-Zip <www.7-zip.org>)
var available_forms = ""; // строка для SQL запроса со списком кодов всех доступных пользователю форм

//=====================================================
//  ОБЩИЕ ФУНКЦИИ
//=====================================================

// Находит имя хоста если путь указывает на сетевой каталог
function GetHostName(path){
	var drive = FSO.GetDrive(FSO.GetDriveName(path));
	var uncPath = drive.ShareName;
	if (uncPath) return uncPath.replace(/^(\\\\\w*).*/, '$1');
}

// Выполняет SQL запрос к БД
function QueryDatabase(sql_query){
	var table = [];
	try {
		objConn = new ActiveXObject("ADODB.Connection");
		objConn.Open(connect);
		with (objConn.Execute(sql_query)){
			if (Fields.Count > 0) {
				while (!EOF){
					var tmp = [];
					for (var f=0; f<Fields.Count; f++) {
						tmp[f] = Fields(f).Value;
					}
					table[table.length] = tmp;
					MoveNext();
				}
			}
		}
		objConn.Close();
	} catch(err) {
		alert("Error: " + err.description);
		self.close();
	}
	return table;
}

// Read text file
function ReadTextFile(filename) {
	var text = '';
	if (FSO.FileExists(filename)) {
		if (FSO.GetFile(filename).Size > 0) {
			with (FSO.OpenTextFile(filename)) {
				text = ReadAll();
				Close();
			}
		}
	}
	return text;
}

// Read binary file
function ReadBinaryFile(filename) {
	with (Stream) {
		type=2;
		charset='windows-1251';
		open();
		loadFromFile(filename);
		var content=readText();
		close();
	}
	return content;
}

// Save binary data
function SaveBinaryData(filename, text) {
	with (Stream) {
		Type = 2;
		charset='windows-1251';
		Open();
		WriteText (text);
		SaveToFile (filename, 2);
		Close();
	}
}

// Перекодировщик текста dos866 -> win1251
function dos2win(text_in){
	with (Stream) {
		Open();
		Type = 2;
		Charset = 'windows-1251';
		WriteText(text_in);
		Flush();
		Position = 0;
		Charset = 'cp866';
		var text_out = ReadText(-1);
		Close();
	}
	return text_out;
}

// Возвращает результат запуска консольной команды в заданном каталоге
function RunConsole(command, dir){
	var output = {};
	if (!FSO.FolderExists(dir)) FSO.CreateFolder(dir);
	WshShell.CurrentDirectory = dir;
	var output_file = '$output.tmp';
	output.ret = WshShell.Run('%COMSPEC% /c @'+command+' > ' + output_file + ' 2<&1', 0, true);
	output.text = ReadTextFile(output_file);
	if (output.text != '') output.text = dos2win(output.text);
	return output;
}

// Возвращает массив со списком файлов в архиве любой вложенности
function GetArcFileList(arc_fullname) {
	var archive_list = script_path + '\\bin\\archive_list.cmd';
	var cmd = archive_list + ' ' + arc_fullname;
	var filelist = RunConsole(cmd, tmp_dir).text;
	// var arr_files = filelist.split('\r\n');
	// arr_files.pop();
	return filelist;
}

// Return date as object
function FormatDate(objDate){
	function format(x){return (x < 10) ? ('0' + x) : String(x);}
	var datetime = {};
	datetime.year = String(objDate.getYear());      // yyyy
	datetime.month = format(objDate.getMonth()+1);  // mm
	datetime.day = format(objDate.getDate());       // dd
	datetime.hours = format(objDate.getHours());          // hh
	datetime.min = format(objDate.getMinutes());          // mm
	datetime.sec = format(objDate.getSeconds());          // ss
	return datetime;
}

// Создание ярлыка на Рабочем столе
function CreateShortcut(){
	with (WshShell.CreateShortcut(WshShell.SpecialFolders("Desktop") + "\\ПТК ПСД - Обозреватель отчетности.lnk")){
		TargetPath = unescape(document.URL).replace(/.*([A-Z]:\\.+)$/i, '$1');
		IconLocation = "%windir%\\system32\\mqutil.dll";
		Description = "Обозреватель отчетности ПТК ПСД";
		Save();
	}
	WshShell.Popup("Ярлык для запуска приложения\nустановлен на Вашем Рабочем столе!", 3, hta_App.applicationName, 64);
}

// Чтение ini файла в объект INI
function ReadINIFile(ini_file) {
	if ((FSO.FileExists(ini_file)) && (FSO.GetFile(ini_file).Size > 0)) {
		with (FSO.OpenTextFile(ini_file)) {
			var text = ReadAll();
			Close();
			var arr_lines = text.split('\n');
			var section, param, value;
			for (var i in arr_lines){
				if (/^\[(\w+)\]/.test(arr_lines[i])){
					section = RegExp.$1;
					if (!INI[section]) INI[section] = {};
				}
				if (/^([^;#][^=]*?)\s*=\s*([^\r\n]*?)\s*$/.test(arr_lines[i])){
					param = RegExp.$1;
					value = RegExp.$2;
					INI[section][param] = value;
				}
			}
		}
	}
	return INI;
}

// Возвращает полный путь к выбранному файлу отчетности
function GetCurrentFile(ind){
	var dt = FormatDate(new Date(ATable[ind][2]));
	return store_dir + dt.year + '\\' + dt.month + '\\' + dt.day + '\\' + ATable[ind][3];
}

//=====================================================
//  ОБРАБОТКА НАЖАТИЙ НА КЛАВИАТУРУ И ПЕРЕМЕЩЕНИЯ МЫШИ
//=====================================================

// Подсветка выделенной строки
function SelectLine(){
	if (select_row == current_row) return;
	var select_color = "buttonface";
	PostList.Row[select_row].style.backgroundColor = "";
	PostList.Row[current_row].style.backgroundColor = select_color;
	select_row_bg = select_color;
	select_row = current_row;
	select_index = PostList.Row[select_row].name;
	select_fileNameTime = ATable[select_index][3];
	select_fileName = select_fileNameTime.replace(/\.[^.]+$/,'');
	select_filePathNameTime = GetCurrentFile(select_index);
	ShowPreview();
}

// Подсветка текущей строки
function HighlightCurrentRow(){
	if (current_row === undefined) return;
	if (current_row != old_row){
		PostList.Row[old_row].style.backgroundColor = select_row_bg;
		select_row_bg = PostList.Row[current_row].style.backgroundColor;
		PostList.Row[current_row].style.backgroundColor = "infobackground";
		old_row = current_row;
	}
}

// Обработка перемещения мыши
function OnMouseOver(){
	var element = PostList.event.srcElement;
	do {
		element = element.parentElement;
		current_row = element.rowIndex;
	} while (!current_row);
	HighlightCurrentRow();
}

// Обработка нажатий на клавиши
function OnKeydown(){
	var key_code = PostList.event.keyCode;
	if ((key_code == 40)&&(current_row<PostList.Row.length-1)){
		current_row++;
		if ((!PostList.Row[current_row].name)&&(current_row<PostList.Row.length-1))current_row++;
	}
	if ((key_code == 38)&&(current_row>1)){
		current_row--;
		if ((!PostList.Row[current_row].name)&&(current_row>0))current_row--;
	}
	HighlightCurrentRow();
	SelectLine();
}

//=====================================================
//  ОБРАБОТКА ПУНКТОВ КОНТЕКСТНОГО МЕНЮ
//=====================================================

// Показывает контекстное меню по правой кнопке мыши
function ShowRCMenu(pane){
	// вставляем html содержимое меню
	var html_menu = '<table width=100% cellpadding=2 cellspacing=0>';
	switch(pane.name){
		case 'PostList':
			html_menu += '<tr id=\"menuitem\" onClick=\"parent.PrintForm();\">';
			html_menu += '<td style=\"font:12pt Wingdings;\">3';
			html_menu += '<td>&nbsp;Печать&nbsp;';
			html_menu += '<tr id=\"menuitem\" onClick=\"parent.OpenExplorer();\">';
			html_menu += '<td style=\"font:10pt Wingdings;\">1';
			html_menu += '<td>&nbsp;Открыть каталог&nbsp;';
			html_menu += '<tr id=\"menuitem\" onClick=\"parent.SaveRace();\">';
			html_menu += '<td style=\"font:12pt Wingdings;\">&lt;';
			html_menu += '<td>&nbsp;Сохранить посылку в...&nbsp;';
			html_menu += '<tr id=\"menuitem\" onClick=\"parent.SaveUnpackAll();\">';
			html_menu += '<td style=\"font:12pt Wingdings;\">4';
			html_menu += '<td>&nbsp;Распаковать все файлы в...&nbsp;';
			if (/решен|запрос/i.test(PostList.Row[select_row].innerText)) { // пункт "Сформировать подтверждения" отображается только на запросах и решениях 365П
				html_menu += '<tr id=\"menuitem\" onClick=\"parent.Answer365P();\">';
				html_menu += '<td style=\"font:12pt Wingdings;\">+';
				html_menu += '<td>&nbsp;Сформировать подтверждения&nbsp;';
			}
			break;
		case 'Preview':
			html_menu += '<tr id=\"menuitem\" onClick=\"parent.SaveRace();\">';
			html_menu += '<td style=\"font:12pt Wingdings;\">&lt;';
			html_menu += '<td>&nbsp;Сохранить всю посылку в...&nbsp;';
			html_menu += '<tr id=\"menuitem\" onClick=\"parent.SaveRace(true);\">';
			html_menu += '<td style=\"font:12pt Wingdings;\">=';
			html_menu += '<td>&nbsp;Сохранить файл под курсором в...&nbsp;';
			html_menu += '<tr id=\"menuitem\" onClick=\"parent.SaveUnpackAll();\">';
			html_menu += '<td style=\"font:12pt Wingdings;\">4';
			html_menu += '<td>&nbsp;Распаковать все файлы в...&nbsp;';
			break;
		default:
			return;
	}
	html_menu += '</table>';
	RCMenu.document.body.innerHTML = html_menu;

	// добавляем эвенты для подсветки текущего пункта меню
	for (i=0;i<RCMenu.document.all.menuitem.length;i++){
		RCMenu.document.all.menuitem[i].onmouseover = function () {
			this.style.background="activecaption";
			this.style.color="highlighttext";
		};
		RCMenu.document.all.menuitem[i].onmouseout = function () {
			this.style.background="buttonface";
			this.style.color="buttontext";
		};
	}

	// вычисляем размер меню
	RCMenu.show(0, 0, 0, 0, document.body);
	var width = RCMenu.document.body.scrollWidth+4;
	var height = RCMenu.document.body.scrollHeight+5;
	RCMenu.hide();
	// показываем меню
	RCMenu.show(pane.event.x, pane.event.y, width, height, pane.window.document.body);
}

// Извлекаем имя сохраняемого вложенного файла до показа контекстного меню в панели предпросмотра
function PreviewShowContextMenu(obj){
	function GetTextFromHeader(obj){
		return ((obj.tagName == 'TH')||(obj.tagName == 'TR')) ? obj.innerText : '';
	}
	parent.one_filename = GetTextFromHeader(obj); // если кликнули по заголовку
	if (parent.one_filename == '') { // если кликнули по телу сообщения
		parent.one_filename = GetTextFromHeader(Preview.document.all[obj.sourceIndex-3]);
	}
	ShowRCMenu(Preview);
}

// Печать выбранного отчета
function PrintForm(){
	Preview.window.focus();
	Preview.window.print();
}

// Открывает окно Проводника и выделяет файл отчетности
function OpenExplorer(){
	WshShell.Run('explorer /e, /select, ' + select_filePathNameTime);
}

// Удаление ЭЦП у сохраненного файла
function DeleteSignature (filepath){
	var content=escape(ReadBinaryFile(filepath));
	if (/o000000/.test(content)) {
		content=RegExp.leftContext;
		var sign = RegExp.rightContext.match(/\d{4}[0-9A-Z]{6}\d{2}/);
		if (sign) SaveBinaryData(filepath, unescape(content));
	}
}

// Сохранение файла отчетности (целиком или одного из вложенных)
function SaveRace(one_file_from_race){
	var save_root_dir = INI.BrowserSettings.save_root_dir;
	var Shell = new ActiveXObject("Shell.Application");
	var save_filename = ((one_file_from_race) && (one_filename!='')) ? one_filename : select_fileName;
	var objFolder = Shell.BrowseForFolder(0, "Выберите папку для сохранения файла\n" + save_filename, 0, save_root_dir);
	if (!objFolder) return;
	var out_filename = objFolder.Self.Path + '\\' + save_filename;
	var source = ((one_file_from_race) && (one_filename!='')) ? tmp_dir + '\\' + one_filename : select_filePathNameTime;
	FSO.CopyFile(source, out_filename, true);
	if (INI.BrowserSettings.sign_delete_onsave == '1') DeleteSignature(out_filename);
}

// Распаковка всей посылки в указанный каталог
function SaveUnpackAll(){
	var Shell = new ActiveXObject("Shell.Application");
	var objFolder = Shell.BrowseForFolder(0, "Выберите папку для сохранения распакованных файлов", 0, INI.BrowserSettings.save_root_dir);
	if (!objFolder) return;
	var dest_dir = objFolder.Self.Path + '\\';

	var folder = FSO.GetFolder(tmp_dir);
	var files = new Enumerator(folder.Files);
	for (; !files.atEnd(); files.moveNext()){
		var file = files.item();
		if (!/\.(inf|tmp|arj|zip)$/i.test(file.Name)) {
			FSO.CopyFile (file.Path, dest_dir, true);
			if (INI.BrowserSettings.sign_delete_onsave == '1') DeleteSignature(dest_dir + file.Name);
		}
	}
}

// Формирование подтверждений на сообщение 365-П
function Answer365P(){
	function WriteFile(filename, text) {
		with (FSO.OpenTextFile(filename, 2, true)) {
			Write(text);
			Close();
		}
	}
	var outbox_dir_365P = INI.BrowserSettings.outbox_dir_365P;
	if (!outbox_dir_365P) {
		WshShell.Popup('Не задан каталог для выгрузки квитанций !\nОтредактируйте PTK_PSD_Browser.ini', 2, "Ошибка", 48);
		return;
	}
	if (!FSO.FolderExists(outbox_dir_365P)) FSO.CreateFolder(outbox_dir_365P);
	if (FSO.FolderExists(tmp_dir)) FSO.DeleteFile(tmp_dir + '\\*.*', true);

	var arr_fnames = Preview.idFname;
	var count = 0;
	for (var i=0; i<arr_fnames.length; i++) {
		var r_name = arr_fnames[i].innerText;
		if (/([\w_]+)\.vrb$/i.test(r_name)) {
			var fname = RegExp.$1;
			var pb1_text = fname + '###\r\n';
			pb1_text += '10@@@\r\n';
			var dt = FormatDate(new Date());
			pb1_text += dt.year+'-'+dt.month+'-'+dt.day+'@@@\r\n';
			pb1_text += dt.hours+':'+dt.min+':'+dt.sec+'@@@\r\n';
			pb1_text += '===\r\n';
			WriteFile(outbox_dir_365P + '\\PB1_' + fname + '.txt', pb1_text);
			count++;
		}
	}
	var sql_str = "UPDATE elo_arh_post SET error_ = 0 WHERE filename = '" + select_fileNameTime + "'";
	QueryDatabase(sql_str);
	StartRefresh();
	WshShell.Popup('Сформировано:\n- подтверждений:\t'+count, 2, "Формирование подтверждений", 64);
}

//=====================================================
//  ЗАПОЛНЯЕМ ЭЛЕМЕНТАМИ ОКНО ПРИЛОЖЕНИЯ
//=====================================================

// Подготовка фрейма Toolbar (панель инструментов)
function load_Toolbar(){
	with (Toolbar.document.createStyleSheet()){
		addRule('body','margin: 0px;');
		addRule('table','font: normal 10pt Verdana; background-color:threedface;');
		addRule('td','white-space: nowrap;');
		addRule('legend','color:activecaption;');
		addRule('fieldset','margin:5px;');
		addRule('a','text-decoration:none;');
		addRule('a:visited','color:buttontext;');
		addRule('a:hover','color:buttonhighlight;');
		addRule('select','width:130px;');
	}
	var html_toolbar = '';
	html_toolbar += '<table cellpadding=\"0\" cellspacing=\"0\" style=\"width:100%;\"><tr>';
	html_toolbar += '	<td><fieldset><legend><b>&nbsp;Отчетность:&nbsp;</b></legend>';
	html_toolbar += '		&nbsp;<select name=PostType onChange=\"parent.StartRefresh();\"><option value=\"*\">Все формы</option></select>&nbsp;';
	html_toolbar += '	</fieldset>';
	html_toolbar += '	<td valign=middle style=\"font:14pt Wingdings;\"><a href="#" hidefocus title=\"Обновить список\" onClick=\"parent.StartRefresh(); return false;\">[</a>';
	html_toolbar += '	<td><fieldset><legend><b>&nbsp;Период:&nbsp;</b></legend>';
	html_toolbar += '		<input type=\"radio\" id=r0 name=Interval hidefocus onClick=\"parent.SetInterval(0);\" checked>';
	html_toolbar += '		<label for=r0>Сегодня</label>';
	html_toolbar += '		<input type=\"radio\" id=r1 name=Interval hidefocus onClick=\"parent.SetInterval(1);\">';
	html_toolbar += '		<label for=r1>Вчера</label>';
	html_toolbar += '		<input type=\"radio\" id=r2 name=Interval hidefocus onClick=\"parent.SetInterval(2);\">';
	html_toolbar += '		<label for=r2>за 3 дня</label>';
	html_toolbar += '		<input type=\"radio\" id=r3 name=Interval hidefocus onClick=\"parent.SetInterval(3);\">';
	html_toolbar += '		<label for=r3>за 7 дней</label>';
	html_toolbar += '		<input type=\"radio\" id=r4 name=Interval hidefocus onClick=\"parent.SetInterval(4);\">';
	html_toolbar += '		<label for=r4>с:</label>';
	html_toolbar += '		<input hidefocus id=\"startDate\" type=text maxlength=\"10\" style=\"width:70px; text-align:center;\" onkeydown=\"if (event.keyCode == 13) parent.StartRefresh();\">';
	html_toolbar += '		по: <input hidefocus id=\"endDate\" type=text maxlength=\"10\" style=\"width:70px; text-align:center;\" onkeydown=\"if (event.keyCode == 13) parent.StartRefresh();;\">&nbsp;';
	html_toolbar += '	</fieldset>';
	html_toolbar += '	<td style=\"font:14pt Wingdings; width:100%; text-align:center; text-valign:middle;\"><a href="#" hidefocus title=\"Создать на Рабочем столе\nярлык для запуска программы\" onClick=\"parent.CreateShortcut(); return false;\">O</a>&nbsp;';
	html_toolbar += '</table>';
	Toolbar.document.body.innerHTML = html_toolbar;
}

// Подготовка контекстного меню
function load_RCMenu(){
	RCMenu = window.createPopup();
	RCMenu.document.oncontextmenu = function(){return false;};
	RCMenu.document.body.style.border = "2px outset";
	with (RCMenu.document.createStyleSheet()){
		addRule('body','background-color:buttonface;cursor:default;');
		addRule('table','background-color:buttonface; font:menu; margin:0px; width:100%;');
		addRule('td','white-space:nowrap; width:100%;');
	}
}

// Подготовка фрейма PostList (список сообщений)
function load_PostList(){
	with (PostList.document.createStyleSheet()){
		addRule('table','font: normal 10pt Verdana; width:100%; background-color:white; cursor:hand;');
		addRule('th','color:white; background-color:buttonshadow; border-bottom:0; cursor:default;');
		addRule('s','text-decoration:none; font: normal 8pt MS Sans Serif; color:buttonshadow;');
	}
	PostList.document.onkeydown = function(){parent.OnKeydown();};
	PostList.document.body.innerHTML = '<font color="red"><b>Начальная загрузка данных. Ждите...</b></font>';
}

// Подготовка фрейма Preview (просмотр содержимого сообщения)
function load_Preview(){
	with (Preview.document.createStyleSheet()){
		addRule('body','font: normal 10pt Courier New;');
		addRule('q','color:blue; font-weight:bold;');
		addRule('tt','color:blue;');
		addRule('i','color:red; font-weight:bold; font-style:normal;');
		addRule('u','font: normal 8pt MS Sans Serif;');
		addRule('table','font: normal 10pt Courier New; width:100%;');
		addRule('th','color:white; background-color:buttonshadow;');
		addRule('input','font: bold 8pt MS Sans Serif; display: inline;');
		addRule('s','text-decoration:none; font: normal 8pt MS Sans Serif; color:green; background-color:infobackground; display:block;');
		addRule('span','font: normal 8pt MS Sans Serif;');
	}
	Preview.document.onmouseup = function(){
		if (Preview.event.button==2) PreviewShowContextMenu(Preview.event.srcElement);
	};
	Preview.document.title=parent.document.title;
}

// Загружает в раскрывающийся список <SELECT> имена обрабатываемых форм
function CreateFormList(){
	// Проверка зарегистрирован ли пользователь?
	function CheckUsers(usrname){
		var all_users = QueryDatabase("SELECT usrname FROM elo_users");
		for (var i=0; i<all_users.length; i++) {
			if (usrname.toLowerCase() == all_users[i].toString().toLowerCase()) return;
		}
		alert("Пользователь "+usrname+"\nне зарегистрирован в ПТК ПСД!");
		self.close();
	}
	// Извлекает список форм, разрешенных текущему пользователю
	function GetForms(){
		var usrname = INI.User.CurUser;
		if (!usrname) usrname = WshShell.ExpandEnvironmentStrings('%username%');
		document.title += ' [' + usrname + ']';
		CheckUsers(usrname);
		var userid = QueryDatabase("SELECT usrid FROM elo_users WHERE usrname = '" + usrname + "'");
		var available_forms_arr = QueryDatabase('SELECT DISTINCT SP.POSTTYPE ' +
			'FROM ELO_USERS_ACCESS UA LEFT JOIN ELO_SPR_POST_SUB SP ON UA.FORMNAME = SP.CODE ' +
			'WHERE UA.USERID =' + userid);
		available_forms = "'" + available_forms_arr.join("','") + "'"; // сохраним в глобальной переменной (еще понадобится);
		var posttype_name_list = QueryDatabase('SELECT posttype, postname FROM elo_spr_post WHERE posttype IN ' +
			'(' + available_forms + ') ORDER BY postname');
		return posttype_name_list;
	}

	// Заполняем комбобокс
	var forms = GetForms();
	for (var i=0; i<forms.length; i++) {
		var option = Toolbar.document.createElement("option");
		option.value = forms[i][0];
		option.text = forms[i][1].replace(/ПТК ПСД\.\s+/,'');
		Toolbar.PostType.add(option);
	}
}

// Задает интервал дат для выборки
function SetInterval(i){
	function SetDate(days){ // Возвращает строку даты, отстоящую от текущей на заданное кол-во дней
		var objDate = new Date();
		objDate.setTime(days * 24*60*60*1000 + objDate.getTime());
		var dt = FormatDate(objDate);
		return dt.day + '.' + dt.month + '.' + dt.year;
	}

	Toolbar.startDate.disabled = true;
	Toolbar.endDate.disabled = true;

	switch(i){ // Переключатель интервалов
		case 0: // сегодня
			Toolbar.startDate.value = SetDate(0);
			Toolbar.endDate.value = SetDate(1);
			StartRefresh();
			break;
		case 1: // вчера
			Toolbar.startDate.value = SetDate(-1);
			Toolbar.endDate.value = SetDate(0);
			StartRefresh();
			break;
		case 2: // за 3 дня
			Toolbar.startDate.value = SetDate(-2);
			Toolbar.endDate.value = SetDate(1);
			StartRefresh();
			break;
		case 3: // за 7 дней
			Toolbar.startDate.value = SetDate(-6);
			Toolbar.endDate.value = SetDate(1);
			StartRefresh();
			break;
		case 4: // за произвольный период
			Toolbar.startDate.disabled = false;
			Toolbar.endDate.disabled = false;
	}
}

// Проверка правильности задания дат
function CheckDates(){
	function isDate(ds){
		function format(x){return (x < 10) ? ('0' + x) : String(x);}
		var d = ds.split('.');
		var dt = new Date (d[2], d[1]-1, d[0]);
		if ((Number(d[0])==dt.getDate()) &&
			(Number(d[1])==(dt.getMonth()+1)) &&
			(Number(d[2])==dt.getFullYear())) {
			return format(dt.getDate()) + '.' + format(dt.getMonth()+1) + '.' + dt.getFullYear();
		}
		return '';
	}
	if (Toolbar.startDate.disabled) return true;
	var valid_date = isDate(Toolbar.startDate.value);
	if (valid_date == '') {
		Toolbar.startDate.style.color = "red";
		return false;
	}
	if (Toolbar.startDate.style.color == "red") Toolbar.startDate.style.color = "windowtext";
	Toolbar.startDate.value = valid_date;

	valid_date = isDate(Toolbar.endDate.value);
	if (valid_date == '') {
		Toolbar.endDate.style.color = "red";
		return false;
	}
	if (Toolbar.endDate.style.color == "red") Toolbar.endDate.style.color = "windowtext";
	Toolbar.endDate.value = valid_date;

	return true;
}

// Составление списка рейсов
function StartRefresh(){
	if (!CheckDates()) return;
	ATable = [];
	current_row = 0;
	old_row = 0;
	select_row = 0;
	select_row_bg = "";

	PostList.document.body.innerHTML = '<font color="red"><b>Выполняю запрос. Ждите...</b></font>';
	// Получение содержимого SA посылки
	function GetSAcontent(ind){
		// Извлечение имен форм отчетности из текста
		function FindFormName(text, re, name){
			while (re.exec(text)){
				form_names[form_names.length] = name||RegExp.$1;
			}
		}
		select_filePathNameTime = GetCurrentFile(ind);
		var content = '';
		if ((ATable[ind][0] == 'ОЭС')||(ATable[ind][0] == 'ИЭС2')){
			WshShell.Run('cmd /c EXPAND -D "'+select_filePathNameTime+'" > "'+out+'"', 0, true);
			content = ReadTextFile(out);
		}else{
			content = ReadTextFile(select_filePathNameTime);
		}
		var form_names = [];
		// В одной посылке м.б. только одна форма:
		if (/ ZDL\d+\.xls/i.test(content)) return 'Инф.о просроченной задолженности'; // Н.Новгород
		if (/ \d{8}\.[IN]\d{2}/i.test(content)) return '308-П';
		if ((new RegExp(' IA.{3}'+bank_code+'\\.', 'i')).test(content)) return '601'; // С.Петербург
		if ((new RegExp(' IN.{3}'+bank_code+'\\.', 'i')).test(content)) return '652'; // С.Петербург
		if ((new RegExp(' SK.{3}'+bank_code+'\\.', 'i')).test(content)) return 'KAS'; // С.Петербург

		// В одной посылке м.б. несколько различных форм:
		FindFormName(content, new RegExp(' F(.{3})'+bank_code+'[1-C]\\.', 'gi')); // С.Петербург (664, 665, KRK, PSV, VBK)
		FindFormName(content, new RegExp(' F'+bank_code+'(.{2,4})\\.(ZIP|DOC)', 'gi')); // Н.Новгород (308P, 652, 601, 664, 665, KR, PS, VBK)

		return form_names.join(',');
	}
	// Возвращает содержимое сообщения по форме 311-П
	function Get311PContent(ind){
		select_filePathNameTime = GetCurrentFile(ind);
		if (!FSO.FileExists(select_filePathNameTime)) return '';
		var files_list = GetArcFileList(select_filePathNameTime);
		var adr = files_list.match(/([ABCDOPS])\d{13}\.ARJ/i);
		if (adr) {
			adr = adr[1].toUpperCase();
			switch(adr){
				case 'A':
					adr = 'Всем';
					break;
				case 'B':
				case 'O':
					adr = 'ФНС';
					break;
				case 'C':
				case 'P':
					adr = 'ПФ';
					break;
				case 'D':
				case 'S':
					adr = 'ФСС';
					break;
			}
		}
		var content = '';
		var count = files_list.match(/^SB\w\d{9}_\d{12}_\d{16}_\d{3}\.TXT$/igm);
		if (count) {
			content = ' <s>(' + count.length + ')</s>';
			if (adr) content = ' <s>(' + adr + '-' + count.length + ')</s>';
		}
		return content;
	}
	// Возвращает содержимое сообщения по форме 365-П
	function Get365PContent(ind){
		select_filePathNameTime = GetCurrentFile(ind);
		if (!FSO.FileExists(select_filePathNameTime)) return '';
		var files_list = GetArcFileList(select_filePathNameTime);
		var rpo = files_list.match(/^RPO[\w_]{28}\.VRB$/igm);
		var roo = files_list.match(/^ROO[\w_]{28}\.VRB$/igm);
		var zno = files_list.match(/^ZNO[\w_]{28}\.VRB$/igm);
		var kwt = files_list.match(/^KWT[\w_]{31,39}\.txt$/igm);
		var pb1 = files_list.match(/^PB1[\w_]{32}\.txt$/igm);
		var izv = files_list.match(/^IZV[\w_]{36,39}\.txt$/igm);
		var buv = files_list.match(/^BUV[\w_]{24}\.txt$/igm);
		var bos = files_list.match(/^BOS[\w_]{32}\.txt$/igm);
		var html = '';
		if (rpo) html += '<font color="#990000">решение о приост.</font> <s>(' + rpo.length + ')</s> ';
		if (roo) html += '<font color="#990000">отмена решения</font> <s>(' + roo.length + ')</s> ';
		if (zno) html += '<font color="#990000">запрос</font> <s>(' + zno.length + ')</s> ';
		if (kwt) html += 'квит. <s>(' + kwt.length + ')</s> ';
		if (pb1) html += 'подтв. <s>(' + pb1.length + ')</s> ';
		if (izv) html += 'извещение <s>(' + izv.length + ')</s> ';
		if (buv) html += 'уведомление <s>(' + buv.length + ')</s> ';
		if (bos) html += 'свед. об остатках <s>(' + bos.length + ')</s> ';
		return html;
	}
	//Возвращает результат (отправлен/получен/не/принят)
	function postResult(i){
		if (ATable[i][5] == '6') return 'отправлен';
		if (ATable[i][5] == '7'){
			if (ATable[i][8] == '0'){
				if (ATable[i][0] == 'ИЭС1'){
					return 'получен';
				}else{
					return '<font color="green"><b>принят</b></font>';
				}
			}else{
				return '<font color="red"><b>не принят</b></font>';
			}
		}
		return ' ';
	}
	// Форматирование даты для вставки в SQL запрос
	function FormatSQLDate(dt){
		var dt = dt.split('.');
		return "{d\'" + dt[2] + "-" + dt[1] + "-" + dt[0] + "\'}";
	}
	// Возвращает имя формы по типу поста
	function GetFormName(post_type){
		for (var i=0; i<Toolbar.PostType.length; i++) {
			if (Toolbar.PostType.options[i].value == post_type) return Toolbar.PostType.options[i].text;
		}
	}

	var posttype = Toolbar.PostType.options[Toolbar.PostType.selectedIndex].value;
	if (posttype == '*'){
		posttype = " IN (" + available_forms + ")";
	}else{
		posttype = "='"+posttype+"'";
	}
	var sdate = ' dt between '+FormatSQLDate(Toolbar.startDate.value)+' and '+FormatSQLDate(Toolbar.endDate.value);
	var sql_string = "SELECT * FROM elo_arh_post WHERE posttype" + posttype + " and " + sdate + " ORDER BY posttype, dt, filetype";

	ATable = QueryDatabase(sql_string);
	if (ATable.length != 0) {
		var HTMLtable = '<table cellpadding="0" cellspacing="0" border="1" frame="void">';
		var form_name_prev = '';
		for (var i=0; i<ATable.length; i++) {
			if (ATable[i][1] != form_name_prev) {
				HTMLtable += '<tr id="Row"><th colspan=7>'+GetFormName(ATable[i][1]);
				form_name_prev = ATable[i][1];
			}
			HTMLtable += '<tr id="Row" name="' + i + '" onmouseover="parent.OnMouseOver();" onmouseup="parent.SelectLine(); if (event.button==2) parent.ShowRCMenu(self);">';

			HTMLtable += '<td width=14pt><font style="font-family:Wingdings; font-size:12pt; ';
			if (ATable[i][5] == '6'){
				HTMLtable += 'color:blue;" >&#xDB;</font>';
			}else{
				HTMLtable += 'color:green;" >&#xDC;</font>';
			}
			switch(ATable[i][1]){
				case 'sa':
					HTMLtable += '<td>&nbsp;' + ATable[i][0];
					HTMLtable += '<td>&nbsp;' + GetSAcontent(i);
					break;
				case '5z':
				case 'mz':
					HTMLtable += '<td>&nbsp;' + ATable[i][0];
					HTMLtable += '<td>&nbsp;' + Get365PContent(i);
					break;
				case '2z':
					if ((ATable[i][0] == 'ОЭС') || (ATable[i][0] == 'ИЭС2')){
						HTMLtable += '<td colspan=2>&nbsp;' + ATable[i][0] + Get311PContent(i);
					}else{
						HTMLtable += '<td colspan=2>&nbsp;' + ATable[i][0];
					}
					break;
				default:
					HTMLtable += '<td colspan=2>&nbsp;' + ATable[i][0];
			}
			var dt = FormatDate(new Date(ATable[i][2]));
			HTMLtable += '<td>' + dt.day + '.' + dt.month + '.' + dt.year + ' ' + dt.hours + ':' + dt.min;
			HTMLtable += '<td>' + ATable[i][3].replace(/\.[^.]+$/,'');
			HTMLtable += '<td>' + postResult(i);
		}
		HTMLtable += '<\/table>';
		PostList.document.body.innerHTML = HTMLtable;
	} else {
		PostList.document.body.innerHTML = '';
	}
}

// Показ содержимого рейса в нижнем фрейме
function ShowPreview(){
	// Удаление ЭЦП
	function ReplaceSignature(stext){
		if (/o000000/.test(stext)) {
			var text = RegExp.leftContext;
			var sign = RegExp.rightContext;
			var ka = sign.match(/(\d{4}[0-9A-Z]{6}\d{2})\D/);
			ka = ka ? ka[1] : 'не распознан';
			stext = text + '<s>[KA ' + ka + ']</s>';
		}
		return stext;
	}
	// -----------------------------
	// Показ содержимого заархивированного файла
	function ArchiveView(filename){
		// -----------------------------
		// Возвращает содержимое файла
		function GetFileContent(filename){
			var text = ReadBinaryFile(filename);
			var first = text.match(/^.{10}/); // берем первые 10 символов
			if ((!first)||(first[0].match(/[\x00-\x1F]/))) { // и если в них имеется символ с кодом от 0 до 31
				return '&nbsp;&nbsp;&nbsp;<span disabled=1>- - - нечитабельное содержимое - - - </span>';
			}
			if (text != ''){
				text = ReplaceSignature(text);
				if (!/\.xml$/i.test(filename)) {
					if (/[\x80-\xBF]/.test(text)) text = dos2win(text);
					text = text.replace(/\n/g, '<br>');
				}
				// подсветка (подсказки) для содержимого сообщения
				if (/^ZNO[\w_]{28}\.VRB$/i.test(filename)) { // запрос 365П
					text = text.replace(/(<br>ВидЗапр:1)/m, '$1 <q>(запрос о наличии счетов в банке)</q>');
					text = text.replace(/(<br>ВидЗапр:2)/m, '$1 <q>(запрос об остатках денежных средств на счете)</q>');
					text = text.replace(/(<br>ВидЗапр:3)/m, '$1 <q>(запрос выписки по операциям на счете)</q>');
					text = text.replace(/(<br>ТипЗапр:1)/m, '$1 <q>(по всем счетам)</q>');
					text = text.replace(/(<br>ТипЗапр:2)/m, '$1 <q>(по указанным в запросе счетам)</q>');
				} else
				if (/^(PB1|IZV|KWT)[\w_]{31,39}\.txt$/i.test(filename)) { // подтверждение, извещение, квитанция 365П
					text = text.replace(/(<br>10@@@|<br>01@@@|<br>20@@@)/m, '$1 <q>(положительный результат проверки)</q>');
					text = text.replace(/<br>(\d\d)@@@/g, '<br><q>$1</q>@@@');
				}
				return text;
			}
		}
		// -----------------------------
		// Распаковка заархивированного файла
		function UnpackFile(arcfile){
			// не пытаемся распаковать и показать содержимое служебных файлов
			if (/(card\.inf)|(\.xls$)|(\.dat$)|(\.elo$)|(\.doc$)|(\.tif$)|(\.dbf$)/i.test(arcfile)){
				HTML_text += '&nbsp;&nbsp;&nbsp;<span disabled=1>- - - содержимое скрыто - - - </span>';
			}else{
				var out = RunConsole('"'+unpacker+'" e -y "'+arcfile+'"', tmp_dir);
				if (/Error:/.test(out.text)) {
					HTML_text += GetFileContent(arcfile);
				}
				var re = /^Extracting\s+([^\r\n]+)/gm;
				while (re.exec(out.text)){
					var re_lp = RegExp.lastParen;
					HTML_text += '<table border=1 cellpadding=2 cellspacing=0><tr><th id=idFname>'+re_lp+'<tr><td>';
					UnpackFile (re_lp);
					if (/\.vrb$/i.test(re_lp)){ // разделитель страниц для vrb файлов
						HTML_text += '</table><br style="page-break-after:always">';
					}else{
						HTML_text += '</table><br>';
					}
				}
				HTML_text = HTML_text.replace(/<br style=\"page\-break\-after:always\">$/, ''); // удаляем последний разделитель страницы
			}
		}

		// -----------------------------
		Preview.document.body.innerHTML = '<i>Идет распаковка. Ждите...</i>';
		if (!FSO.FileExists(unpacker)) return '<i>' + unpacker + ' не найден!</i>';

		var HTML_text = '';
		if (FSO.FolderExists(tmp_dir)) FSO.DeleteFile(tmp_dir + '\\*.*', true);
		UnpackFile(filename);
		return HTML_text;
	}

	// -----------------------------
	var text = '';
	if (FSO.FileExists(select_filePathNameTime)) {
		text = ReadBinaryFile(select_filePathNameTime);
		if (/^MSCF/.test(text)){
			text = ArchiveView(select_filePathNameTime);
		}else{
			text = ReplaceSignature(text);
			text = text.replace(/\r\n/g, '<br>');
		}
		if (ATable[select_index][5] == '7'){ // подсветка только для полученных
			text = text.replace(/(принята)/g, '<q>$1</q>');
			text = text.replace(/(принято)/g, '<q>$1</q>');
			text = text.replace(/(принят)/g, '<q>$1</q>');
			text = text.replace(/(не )/g, '<i>$1</i>');
		}

		 // подсветка для всех
		var re = new RegExp('('+bank_code+')(.{2,4})(\.zip)', 'gi');
		text = text.replace(re, '$1<q>$2</q>$3');
		re = new RegExp('Z('+bank_code+')(212)(\.doc)', 'gi');
		text = text.replace(re, 'Z$1<q>$2</q>$3');
		text = text.replace(/(\d{2}[.-]\d{2}[.-]\d{4})/g, '<tt>$1</tt>'); // подсветка дат вида 19.03.2010 и 19-03-2010
		text = text.replace(/(201\d[01]\d[0-3]\d)/g, '<tt>$1</tt>'); // подсветка дат вида 20100319
	} else {
		text = '<font color="red">Файл отчета "'+select_filePathNameTime+'" не найден!</font>';
		text += '<p>Для быстрого просмотра необходим отказ от использования архивирования отчетов средствами ПТК ПСД.<br>Настройки ПТК ПСД - Модуль архивирования - Интервал установить в 0.';
	}
	Preview.document.body.innerHTML = text;
}

// Делаем первую выборку
function Start(){
	var DSN = INI.DataBase.ODBC;
	var user = INI.DataBase.user;
	var password = INI.DataBase.password;
	if (DSN) {
		connect = "DSN=" + DSN + ";";
		if (user) connect += "UID=" + user + ";";
		if (password) connect += "PWD=" + password + ";";
	} else {
		var database = ptk_psd_dir + "Database\\etalon97.mdb";
		if (!FSO.FileExists(database)) {
			PostList.document.body.innerHTML = '<font color="red">Файл базы данных '+database+' не найден!</font>';
			return;
		}
		connect = "Driver={Microsoft Access Driver (*.mdb)};DBQ=" + database;
	}

	CreateFormList();
	SetInterval(0);
}

</script>
</head>
<FRAMESET rows="50px, *, 265px" onLoad="load_RCMenu(); setTimeout(Start, 0);">
	<FRAME src="about:blank" onLoad="load_Toolbar();" name="Toolbar" application="yes" marginwidth="0" marginheight="0" scrolling="no" frameborder="0" noresize>
	<FRAME src="about:blank" onLoad="load_PostList();" name="PostList" application="yes" marginwidth="0" marginheight="0" scrolling="yes">
	<FRAME src="about:blank" onLoad="load_Preview();" name="Preview" application="yes" marginwidth="4" marginheight="4">
</FRAMESET>
</HTML>